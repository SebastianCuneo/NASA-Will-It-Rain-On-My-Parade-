<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parade Planner - Prototipo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 1s ease-in-out, color 0.5s ease-in-out; /* Transición suave entre modos */
            min-height: 100vh;
            position: relative;
        }

        /* Definición de colores base */
        :root {
            --nasa-blue: #0B3D91;
            --nasa-red: #FC3D21;
            --gemini-green: #34D399; /* Tailwind green-400 */
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .selectable-option.selected {
            background-color: var(--nasa-blue);
            border-color: #60a5fa;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.5);
        }
         .loading-ring {
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --------------------- ANIMACIÓN DE NUBES Y FONDO --------------------- */

        /* Keyframes para el movimiento de las nubes */
        @keyframes drift {
            0% { transform: translateX(100vw) scale(var(--cloud-scale, 1)); }
            100% { transform: translateX(-150vw) scale(var(--cloud-scale, 1)); }
        }

        .cloud-animation-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Asegura que no bloquee interacciones */
            overflow: hidden;
            z-index: 1; /* Detrás del contenido de la app */
        }

        .cloud {
            position: absolute;
            background: #FFFFFF;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
            opacity: 0.9;
            animation: drift linear infinite;
        }

        .cloud:before, .cloud:after {
            content: '';
            position: absolute;
            background: inherit;
            border-radius: inherit;
            filter: blur(1px);
        }

        .cloud:before {
            width: 60%;
            height: 60%;
            top: -30%;
            left: 30%;
        }

        .cloud:after {
            width: 80%;
            height: 80%;
            top: 20%;
            left: -30%;
        }
        
        /* Configuración de nubes individuales para Day Mode */
        #cloud-1 { --cloud-scale: 1.2; top: 15%; animation-duration: 50s; animation-delay: 0s; width: 120px; height: 120px; }
        #cloud-2 { --cloud-scale: 0.8; top: 55%; animation-duration: 70s; animation-delay: 15s; width: 80px; height: 80px; }
        #cloud-3 { --cloud-scale: 1.0; top: 8%; animation-duration: 60s; animation-delay: 30s; width: 100px; height: 100px; }


        /* --------------------- Estilo MODO NOCHE (Fondo Estrellado) --- */
        .night-mode {
            background-color: #05051a; 
            color: #fff;
            z-index: 10;
            /* Estilo para el fondo estrellado */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.8) 1px, transparent 1px),
                radial-gradient(circle at 70% 80%, rgba(255, 255, 255, 0.7) 0.5px, transparent 0.5px),
                radial-gradient(circle at 45% 55%, rgba(255, 255, 255, 0.6) 0.8px, transparent 0.8px);
            background-size: 100vw 100vh, 200vw 200vh, 150vw 150vh; 
            animation: move-stars 120s linear infinite;
        }

        @keyframes move-stars {
            from { background-position: 0 0; }
            to { background-position: 100vw 100vh, 200vw 200vh, 150vw 150vh; }
        }

        /* Ocultar nubes en modo noche */
        .night-mode .cloud-animation-layer { display: none; }
        .night-mode input, .night-mode .selectable-option, .night-mode #result-card, .night-mode #activity-result-card, .night-mode .bg-slate-800\/50 {
            background-color: #1f2937; /* Base oscura para tarjetas/inputs */
            border-color: #374151;
            color: #fff;
        }

        /* --------------------- Estilo MODO DÍA (Cielo Azul Degrandado + Nubes Animadas) --- */
        .day-mode {
            /* Degradado de celeste a azul más profundo, de arriba a abajo */
            background: linear-gradient(to bottom, #87CEFA 0%, #6A5ACD 150%); /* Degradado sutil */
            color: #1f2937; /* Texto oscuro */
            background-image: none !important; /* Desactiva las estrellas */
            animation: none !important; /* Desactiva la animación */
        }
        
        /* Asegurarse de que el texto y las tarjetas sean legibles en modo día */
        .day-mode header p, .day-mode label {
             color: #374151;
        }

        .day-mode input, .day-mode .selectable-option, .day-mode #result-card, .day-mode #activity-result-card, .day-mode .bg-slate-800\/50 {
             background-color: #e5e7eb; /* Gris claro para tarjetas/inputs */
             border-color: #d1d5db; /* Borde más claro */
             color: #1f2937; /* Texto oscuro */
        }
        
        .day-mode .text-slate-400 {
            color: #4b5563;
        }
        
        .day-mode #summary-message-container {
             background-color: #f3f4f6;
             border-color: #d1d5db;
        }
        
        .day-mode #summary-message {
             color: #374151;
        }

        .day-mode #llm-analysis-button {
             background-color: var(--nasa-blue);
             color: #fff;
        }
        
        .day-mode .bg-red-900\/20 {
             background-color: #fecaca;
             border-color: #ef4444;
             color: #b91c1c;
        }

        .day-mode #llm-analysis-result p {
             background-color: #d1d5db;
             color: #1f2937;
        }
        
        .day-mode #mode-toggle-button {
            color: #0B3D91; /* Icono azul para el sol */
            background-color: #f3f4f6;
        }
        
        .night-mode #mode-toggle-button {
             color: #facc15; /* Icono amarillo para la luna */
             background-color: #1f2937;
        }
        
        /* El contenido de la app debe estar por encima de la animación */
        .app-content {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="text-white min-h-screen relative">
    
    <!-- Botón de Alternancia de Modo -->
    <button id="mode-toggle-button" class="absolute top-4 right-4 p-2 rounded-full shadow-lg transition-colors duration-300 z-20">
         <!-- Icono de Sol -->
         <svg id="mode-icon-sun" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
         <!-- Icono de Luna -->
         <svg id="mode-icon-moon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
    </button>
    
    <!-- Capa de Animación de Nubes (SOLO visible en modo día) -->
    <div id="cloud-layer" class="cloud-animation-layer">
        <div id="cloud-1" class="cloud"></div>
        <div id="cloud-2" class="cloud"></div>
        <div id="cloud-3" class="cloud"></div>
    </div>


    <div class="max-w-md mx-auto p-4 md:p-6 app-content">
        
        <header class="text-center my-8">
            <h1 class="text-4xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-red-500 to-blue-500">
                UcuWeather
            </h1>
            <!-- Se reemplaza el texto por un placeholder que simula el logo de la NASA -->
            <p class="text-slate-400 mt-2 flex items-center justify-center space-x-2">
                <span>Planifica tu día perfecto con</span>
                <img src="https://placehold.co/80x20/0B3D91/FFFFFF?text=NASA" alt="Logo de la NASA" class="inline h-5 w-auto rounded-md" />
            </p>
        </header>

        <main>
            <form id="weather-form" class="space-y-6">
                <!-- Paso 1: Ubicación -->
                <div>
                    <label for="location" class="block text-sm font-bold text-slate-300 mb-2">Paso 1: Elige la ubicación</label>
                    <div class="relative">
                         <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                        <input type="text" id="location" name="location" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-3.5" placeholder="Ej: Montevideo, Uruguay" value="Montevideo" required>
                    </div>
                </div>

                <!-- Paso 2: Fecha -->
                <div>
                    <label for="date" class="block text-sm font-bold text-slate-300 mb-2">Paso 2: Selecciona la fecha</label>
                    <input type="date" id="date" name="date" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3.5" required>
                </div>

                <!-- Paso 3: Condiciones -->
                <div>
                    <label class="block text-sm font-bold text-slate-300 mb-2">Paso 3: ¿Qué condiciones te preocupan?</label>
                    <div id="weather-options" class="grid grid-cols-3 gap-3">
                        <div class="selectable-option weather-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square selected" data-condition="wet">
                            <span class="text-3xl">🌧️</span><span class="font-bold text-xs text-center mt-1">Muy Lluvioso</span>
                        </div>
                        <div class="selectable-option weather-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square selected" data-condition="hot">
                            <span class="text-3xl">🔥</span><span class="font-bold text-xs text-center mt-1">Muy Caluroso</span>
                        </div>
                        <div class="selectable-option weather-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-condition="cold">
                           <span class="text-3xl">❄️</span><span class="font-bold text-xs text-center mt-1">Muy Frío</span>
                        </div>
                        <div class="selectable-option weather-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-condition="windy">
                           <span class="text-3xl">💨</span><span class="font-bold text-xs text-center mt-1">Muy Ventoso</span>
                        </div>
                        <div class="selectable-option weather-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-condition="uncomfortable">
                           <span class="text-3xl">🥵</span><span class="font-bold text-xs text-center mt-1">Incómodo</span>
                        </div>
                        <div class="selectable-option weather-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-condition="uv">
                           <span class="text-3xl">☀️</span><span class="font-bold text-xs text-center mt-1">Radiación UV</span>
                        </div>
                    </div>
                </div>

                <!-- Paso 4: Actividad (Opcional) -->
                <div>
                    <label class="block text-sm font-bold text-slate-300 mb-2">Paso 4 (Opcional): Elige una actividad</label>
                    <div id="activity-options" class="grid grid-cols-3 gap-3">
                        <div class="selectable-option activity-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-activity="surf">
                            <span class="text-3xl">🏄</span><span class="font-bold text-xs text-center mt-1">Surfear</span>
                        </div>
                        <div class="selectable-option activity-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-activity="beach">
                            <span class="text-3xl">🏖️</span><span class="font-bold text-xs text-center mt-1">Día de Playa</span>
                        </div>
                        <div class="selectable-option activity-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-activity="run">
                            <span class="text-3xl">🏃‍♂️</span><span class="font-bold text-xs text-center mt-1">Correr</span>
                        </div>
                         <div class="selectable-option activity-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-activity="hike">
                            <span class="text-3xl">⛰️</span><span class="font-bold text-xs text-center mt-1">Senderismo</span>
                        </div>
                         <div class="selectable-option activity-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-activity="sailing">
                            <span class="text-3xl">⛵</span><span class="font-bold text-xs text-center mt-1">Navegar</span>
                        </div>
                         <div class="selectable-option activity-option flex flex-col items-center justify-center p-3 bg-slate-800 border-2 border-slate-700 rounded-lg cursor-pointer transition-all duration-200 aspect-square" data-activity="picnic">
                            <span class="text-3xl">🧺</span><span class="font-bold text-xs text-center mt-1">Picnic</span>
                        </div>
                    </div>
                </div>

                <button type="submit" id="submit-button" class="w-full text-white font-bold py-4 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-800" style="background-color: var(--nasa-blue);">
                    Analizar Probabilidad Histórica
                </button>
            </form>
        </main>
        
        <section id="results-section" class="hidden mt-10">
            <!-- Tarjeta de Actividad / Sugerencias -->
            <div id="activity-result-card" class="mb-8 bg-slate-800 border border-slate-700 rounded-xl p-6 shadow-2xl shadow-blue-500/10">
                 <p id="activity-title" class="text-center font-bold text-xl mb-4"></p>
                 <div id="activity-recommendation" class="text-center"></div>
            </div>

            <!-- Tarjeta de Resumen Climático -->
            <div id="result-card" class="bg-slate-800 border border-slate-700 rounded-xl p-6 text-center">
                <p class="font-bold mb-4">Resumen del Clima</p>
                <div id="result-emojis" class="text-5xl mb-4 flex justify-center gap-x-3"></div>
                <p class="text-slate-400 text-lg" id="result-description"></p>
                <p class="text-7xl font-black my-2" id="result-percentage"></p>
                <div class="flex justify-center mt-4">
                    <span id="result-risk-tag" class="text-sm font-bold px-4 py-1.5 rounded-full"></span>
                </div>
                 <div id="summary-message-container" class="mt-6 text-left bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                    <p class="font-bold text-lg">Recomendación General:</p>
                    <p id="summary-message" class="text-slate-300"></p>
                    <!-- Nuevo elemento para el análisis estratégico LLM -->
                    <button id="llm-analysis-button" class="mt-4 w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
                        ✨ Generar Análisis Estratégico (IA)
                    </button>
                    <div id="llm-analysis-result" class="mt-4 text-sm text-yellow-300 hidden"></div>
                </div>
            </div>

            <!-- Huella del tiempo -->
            <div class="mt-8">
                <h2 class="text-2xl font-bold text-center mb-4">La Huella del Tiempo</h2>
                <p class="text-center text-slate-400 mb-6">Así ha cambiado el riesgo de estas condiciones con el tiempo.</p>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4">
                        <p class="text-sm font-bold text-blue-400">PASADO (1980-2000)</p>
                        <svg viewBox="0 0 100 60" class="w-full h-auto my-2"><path d="M0,60 Q25,40 50,50 T100,45 L100,60 Z" fill="#22c55e"></path><circle cx="20" cy="20" r="10" fill="#facc15"></circle><rect x="65" y="35" width="5" height="15" fill="#8d5524"></rect><circle cx="67.5" cy="30" r="8" fill="#16a34a"></circle></svg>
                        <p class="text-3xl font-bold" id="past-percentage"></p>
                    </div>
                    <div class="bg-red-900/20 border border-red-500 rounded-xl p-4">
                         <p class="text-sm font-bold" style="color: var(--nasa-red);">PRESENTE (2001-2023)</p>
                         <svg viewBox="0 0 100 60" class="w-full h-auto my-2"><path d="M0,60 Q25,50 50,52 T100,48 L100,60 Z" fill="#a16207"></path><circle cx="20" cy="20" r="12" fill="#fb923c"></circle><path d="M 65 50 L 63 35 L 70 35 Z" fill="#5c4033"></path></svg>
                         <p class="text-3xl font-bold" id="present-percentage"></p>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-slate-800 border border-slate-700 rounded-xl p-6">
                <h3 class="font-bold text-lg mb-2">Distribución Histórica</h3>
                <p class="text-sm text-slate-400 mb-4">Gráfico de frecuencia de las mediciones históricas. La línea roja marca el umbral del 10% más extremo.</p>
                <div class="bg-slate-700 h-40 w-full rounded-lg flex items-center justify-center text-slate-500 text-xs">
                    [ Aquí iría un gráfico de barras (histograma) ]
                </div>
                <button class="mt-6 w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    Descargar Datos (CSV)
                </button>
            </div>
        </section>
    </div>

    <script>
        // Configuración de la API de Gemini (clave vacía para el entorno Canvas)
        const apiKey = ""; 
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";

        const form = document.getElementById('weather-form');
        const submitButton = document.getElementById('submit-button');
        const resultsSection = document.getElementById('results-section');
        const weatherOptions = document.querySelectorAll('.weather-option');
        const activityOptions = document.querySelectorAll('.activity-option');
        const llmAnalysisButton = document.getElementById('llm-analysis-button');
        const llmAnalysisResult = document.getElementById('llm-analysis-result');
        const modeToggleButton = document.getElementById('mode-toggle-button');
        const body = document.body;
        const modeIconSun = document.getElementById('mode-icon-sun');
        const modeIconMoon = document.getElementById('mode-icon-moon');
        const cloudLayer = document.getElementById('cloud-layer');
        
        // Almacenamiento de datos del último análisis para el LLM
        let lastAnalysisData = null; 

        // --- LÓGICA DÍA / NOCHE ---
        
        /** * Aplica el modo (día/noche) basado en la preferencia del usuario (localStorage)
         * o en la hora actual si no hay preferencia.
         */
        function applyMode(isNightMode) {
            if (isNightMode) {
                body.classList.remove('day-mode');
                body.classList.add('night-mode');
                modeIconSun.classList.add('hidden');
                modeIconMoon.classList.remove('hidden');
                cloudLayer.classList.add('hidden');
            } else {
                body.classList.remove('night-mode');
                body.classList.add('day-mode');
                modeIconSun.classList.remove('hidden');
                modeIconMoon.classList.add('hidden');
                cloudLayer.classList.remove('hidden');
            }
        }
        
        /**
         * Determina el modo inicial o aplica la preferencia guardada.
         */
        function initializeMode() {
            const savedMode = localStorage.getItem('themeMode'); // 'day' o 'night'
            let isNightMode;
            
            if (savedMode) {
                isNightMode = savedMode === 'night';
            } else {
                // Si no hay preferencia, usa la hora del sistema
                const now = new Date();
                const hour = now.getHours();
                const sunriseHour = 7;
                const sunsetHour = 19;
                isNightMode = !(hour >= sunriseHour && hour < sunsetHour);
            }
            applyMode(isNightMode);
        }

        modeToggleButton.addEventListener('click', () => {
            const isNightMode = body.classList.contains('night-mode');
            const newMode = isNightMode ? 'day' : 'night';
            
            localStorage.setItem('themeMode', newMode);
            applyMode(newMode === 'night');
        });

        // Llamar a la función inmediatamente al cargar
        document.addEventListener('DOMContentLoaded', initializeMode);
        // --- FIN LÓGICA DÍA / NOCHE ---


        // Datos de ejemplo con alcance global dentro del script
        const mockData = {
            wet: { text: 'lluvioso', percentage: 18.2, pastPercentage: 11.5, advice: "no olvides un paraguas." },
            hot: { text: 'caluroso', percentage: 25.7, pastPercentage: 19.1, advice: "mantente hidratado." },
            cold: { text: 'frío', percentage: 8.3, pastPercentage: 12.4, advice: "abrigate bien." },
            windy: { text: 'ventoso', percentage: 33.1, pastPercentage: 28.9, advice: "cuidado con objetos sueltos." },
            uncomfortable: { text: 'incómodo', percentage: 45.5, pastPercentage: 38.1, advice: "usa ropa ligera." },
            uv: { text: 'alta radiación UV', percentage: 60.1, pastPercentage: 52.3, advice: "usa protector solar." }
        };

        // Selección de múltiples condiciones climáticas
        weatherOptions.forEach(option => {
            option.addEventListener('click', () => {
                option.classList.toggle('selected');
            });
        });

        // Selección de una sola actividad
        activityOptions.forEach(option => {
            option.addEventListener('click', () => {
                // Si ya está seleccionada, la deseleccionamos
                if (option.classList.contains('selected')) {
                    option.classList.remove('selected');
                } else {
                    // Deseleccionar cualquier otra y seleccionar la nueva
                    activityOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                }
            });
        });

        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const selectedWeather = document.querySelectorAll('.weather-option.selected');
            const selectedActivity = document.querySelector('.activity-option.selected');
            
            if (selectedWeather.length === 0) {
                // Usar un modal o mensaje en lugar de alert()
                showTemporaryMessage('Por favor, selecciona al menos una condición climática.', 'text-red-400');
                return;
            }

            const conditions = Array.from(selectedWeather).map(opt => opt.dataset.condition);
            const activity = selectedActivity ? selectedActivity.dataset.activity : null;
            const location = document.getElementById('location').value;
            const date = document.getElementById('date').value;

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="loading-ring"></span> Analizando datos de la NASA...';
            resultsSection.classList.add('hidden');
            llmAnalysisResult.classList.add('hidden'); // Ocultar análisis anterior
            llmAnalysisButton.disabled = true;

            setTimeout(() => {
                const results = displayMockResults(conditions, activity, location, date);
                lastAnalysisData = results; // Guardar resultados para el LLM
                submitButton.disabled = false;
                submitButton.textContent = 'Analizar Probabilidad Histórica';
                resultsSection.classList.remove('hidden');
                llmAnalysisButton.disabled = false;
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 2000);
        });

        llmAnalysisButton.addEventListener('click', async () => {
             if (!lastAnalysisData) return;
             await generateStrategicAnalysis(lastAnalysisData);
        });

        function showTemporaryMessage(message, classes) {
            const container = document.getElementById('weather-form').parentNode;
            let msgEl = container.querySelector('#temp-message');
            if (!msgEl) {
                msgEl = document.createElement('div');
                msgEl.id = 'temp-message';
                msgEl.className = 'mt-3 p-3 text-center rounded-lg font-bold transition-all duration-300';
                container.insertBefore(msgEl, form.nextSibling);
            }
            msgEl.className = `mt-3 p-3 text-center rounded-lg font-bold transition-all duration-300 ${classes}`;
            msgEl.textContent = message;

            setTimeout(() => {
                msgEl.remove();
            }, 3000);
        }

        function displayMockResults(conditions, activity, location, date) {
            // --- Lógica del Clima General ---
            let totalPercentage = 0, totalPastPercentage = 0, emojis = '';
            let summaryParts = [], adviceParts = [];
            
            conditions.forEach(c => {
                const data = mockData[c];
                totalPercentage += data.percentage;
                totalPastPercentage += data.pastPercentage;
                emojis += {wet:'🌧️', hot:'🔥', cold:'❄️', windy:'💨', uncomfortable:'🥵', uv:'☀️'}[c];
                summaryParts.push(data.text);
                adviceParts.push(data.advice);
            });

            const avgPercentage = totalPercentage / conditions.length;
            const avgPastPercentage = totalPastPercentage / conditions.length;
            
            // Determinar nivel de riesgo
            let riskLevel, riskColorClasses;
            if (avgPercentage < 20) { riskLevel = 'Bajo'; riskColorClasses = 'bg-green-500/20 text-green-300'; }
            else if (avgPercentage < 40) { riskLevel = 'Moderado'; riskColorClasses = 'bg-yellow-500/20 text-yellow-300'; }
            else { riskLevel = 'Alto'; riskColorClasses = 'bg-red-500/20 text-red-300'; }

            // --- Lógica de Actividad ---
            const activityTitleEl = document.getElementById('activity-title');
            const activityRecEl = document.getElementById('activity-recommendation');
            let isActivityGood = true;
            let activityReason = null;
            let activityName = activity ? activitiesDB[activity].name : null;

            if (activity) {
                const compatibility = checkActivityCompatibility(conditions, activity);
                activityTitleEl.textContent = `Análisis para: ${compatibility.name}`;
                let recommendationHTML = `<p class="text-3xl mb-2">${compatibility.icon}</p><p class="text-lg">${compatibility.message}</p>`;
                if (!compatibility.isGood) {
                    isActivityGood = false;
                    activityReason = compatibility.reason;
                    // Búsqueda del Plan B con LLM
                    recommendationHTML += `<div id="plan-b-section" class="mt-4 p-3 bg-slate-900 rounded-lg">
                        <p class="text-sm font-bold text-red-400 mb-2">¡Plan B Activo! ✨</p>
                        <p id="plan-b-message">Generando alternativas...</p>
                    </div>`;
                    generatePlanB(conditions, activity, activityRecEl);
                }
                activityRecEl.innerHTML = recommendationHTML;
            } else {
                // Sugerencias si no se eligió actividad
                const suggestions = suggestActivities(conditions);
                activityTitleEl.textContent = "Sugerencias de Actividades";
                activityRecEl.innerHTML = `<p>Basado en el clima, hoy podría ser un buen día para:</p><p class="text-3xl mt-4">${suggestions.join(' ')}</p>`;
            }

            // --- Renderizado de resultados ---
            document.getElementById('result-emojis').textContent = emojis;
            document.getElementById('result-description').textContent = `Probabilidad combinada:`;
            document.getElementById('result-percentage').textContent = `${avgPercentage.toFixed(1)}%`;
            document.getElementById('summary-message').textContent = "Por lo tanto, " + adviceParts.join(" Además, ");

            const riskTag = document.getElementById('result-risk-tag');
            riskTag.textContent = `Riesgo ${riskLevel}`;
            riskTag.className = `text-sm font-bold px-4 py-1.5 rounded-full ${riskColorClasses}`;

            document.getElementById('past-percentage').textContent = `${avgPastPercentage.toFixed(1)}%`;
            document.getElementById('present-percentage').textContent = `${avgPercentage.toFixed(1)}%`;

            // Devolver datos estructurados para el LLM
            return {
                location,
                date,
                conditions: conditions.map(c => mockData[c].text),
                avgPercentage: avgPercentage.toFixed(1),
                riskLevel,
                climateChangeDelta: (avgPercentage - avgPastPercentage).toFixed(1),
                activity: activityName,
                isActivityGood
            };
        }

        const activitiesDB = {
            surf: { name: "Surfear", icon: "🏄", dislikes: ['cold', 'wet'], likes: ['windy'] },
            beach: { name: "Día de Playa", icon: "🏖️", dislikes: ['wet', 'cold', 'windy'] },
            run: { name: "Correr", icon: "🏃‍♂️", dislikes: ['hot', 'wet', 'uncomfortable'] },
            hike: { name: "Senderismo", icon: "⛰️", dislikes: ['hot', 'wet', 'uncomfortable'] },
            sailing: { name: "Navegar", icon: "⛵", dislikes: ['wet'], likes: ['windy'] },
            picnic: { name: "Picnic", icon: "🧺", dislikes: ['wet', 'windy', 'cold'] }
        };

        function checkActivityCompatibility(conditions, activity) {
            const currentActivity = activitiesDB[activity];
            let badCondition = null;

            for (const condition of conditions) {
                if (currentActivity.dislikes.includes(condition)) {
                    badCondition = condition;
                    break;
                }
            }
            
            if (badCondition) {
                return { 
                    isGood: false, 
                    name: currentActivity.name, 
                    icon: '👎', 
                    message: `No parece el mejor día. La alta probabilidad de clima ${mockData[badCondition].text} podría complicar la actividad.`, 
                    reason: mockData[badCondition].text 
                };
            } else {
                return { 
                    isGood: true, 
                    name: currentActivity.name, 
                    icon: '👍', 
                    message: `¡Parece un día excelente para tu actividad! Las condiciones son favorables.` 
                };
            }
        }

        function suggestActivities(conditions) {
            let suggestions = [];
            if (!conditions.includes('wet') && !conditions.includes('cold') && !conditions.includes('windy')) suggestions.push('🧺');
            if (!conditions.includes('wet') && !conditions.includes('cold')) suggestions.push('🏖️');
            if (!conditions.includes('hot') && !conditions.includes('wet')) suggestions.push('🏃‍♂️', '⛰️');
            if (conditions.includes('windy') && !conditions.includes('wet')) suggestions.push('⛵');
            if(suggestions.length === 0) return ['🏠']; // Si el clima es malo para todo, sugiere quedarse en casa
            return suggestions;
        }

        // --- FUNCIONES DE LLAMADA AL GEMINI API ---

        // Función de utilidad para manejar reintentos con backoff exponencial
        async function fetchWithRetry(url, payload, retries = 3) {
            const headers = { 'Content-Type': 'application/json' };
            const fullUrl = `${url}?key=${apiKey}`;

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(fullUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 429 && i < retries - 1) {
                        // Too Many Requests (Rate Limit), wait and retry
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // 1. Generar Análisis Estratégico (Usa solo texto)
        async function generateStrategicAnalysis(data) {
            const originalText = llmAnalysisButton.innerHTML;
            llmAnalysisButton.disabled = true;
            llmAnalysisButton.innerHTML = '<span class="loading-ring"></span> Analizando con IA...';
            llmAnalysisResult.classList.remove('hidden');
            llmAnalysisResult.innerHTML = '<p class="text-slate-400">Generando informe estratégico...</p>';

            const systemPrompt = `Eres un meteorólogo y analista de riesgos especializado en datos históricos de la NASA. Tu tarea es convertir el análisis técnico en un resumen estratégico para ejecutivos. El resumen debe ser formal, conciso (máximo 120 palabras), y destacar los hallazgos clave, el nivel de riesgo y la implicación del cambio climático.`;
            
            const userQuery = `Analiza este pronóstico climático histórico para la fecha ${data.date} en ${data.location}:
            - Condiciones analizadas: ${data.conditions.join(', ')}
            - Probabilidad Histórica Combinada (Riesgo): ${data.avgPercentage}%
            - Nivel de Riesgo: ${data.riskLevel}
            - Delta de Cambio Climático (actual vs pasado): +${data.climateChangeDelta}% (indica aumento de riesgo en el tiempo)`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await fetchWithRetry(apiUrl, payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error al generar el análisis.";
                // Usamos el color de fondo de la tarjeta principal para el texto en modo día
                const bgColor = body.classList.contains('day-mode') ? 'bg-slate-200' : 'bg-slate-700'; 
                const textColor = body.classList.contains('day-mode') ? 'text-gray-800' : 'text-white';
                llmAnalysisResult.innerHTML = `<p class="${textColor} ${bgColor} p-4 rounded-lg shadow-inner">${text}</p>`;

            } catch (error) {
                console.error("Gemini API Error (Strategic Analysis):", error);
                llmAnalysisResult.innerHTML = `<p class="text-red-400">Error al contactar la IA: ${error.message}. Inténtalo de nuevo.</p>`;
            } finally {
                llmAnalysisButton.innerHTML = originalText;
                llmAnalysisButton.disabled = false;
            }
        }


        // 2. Generar Plan B (Usa JSON estructurado para actividades)
        async function generatePlanB(badConditions, originalActivity, containerElement) {
            const planBContainer = containerElement.querySelector('#plan-b-message');
            const originalMessage = planBContainer.innerHTML;
            planBContainer.innerHTML = '<span class="loading-ring"></span> Pensando en alternativas...';

            // Mapeo inverso de condiciones a emojis para el prompt
            const conditionEmojis = {
                'lluvioso': '🌧️', 'caluroso': '🔥', 'frío': '❄️', 'ventoso': '💨', 
                'incómodo': '🥵', 'alta radiación UV': '☀️'
            };
            const incompatibleConditionsText = badConditions.map(c => `${conditionEmojis[mockData[c].text]} ${mockData[c].text}`).join(' y ');

            const systemPrompt = `Eres un experto en ocio y actividades al aire libre. Genera un array JSON de 2 actividades alternativas (con su nombre y un breve resumen) que sean compatibles con las condiciones climáticas dadas, evitando la actividad original. No incluyas el código JSON en tu respuesta.`;
            
            const userQuery = `La actividad original ${activitiesDB[originalActivity].name} no es recomendable debido a las condiciones de ${incompatibleConditionsText}. Sugiere exactamente 2 actividades alternativas que sí sean adecuadas para este clima. Las actividades sugeridas deben ser prácticas y sensatas.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "activityName": { "type": "STRING" },
                                "recommendation": { "type": "STRING" }
                            }
                        }
                    }
                }
            };

            try {
                const result = await fetchWithRetry(apiUrl, payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                const alternatives = JSON.parse(jsonText);
                
                let html = '<p class="text-sm font-bold text-slate-300">Actividades Alternativas:</p>';
                alternatives.forEach(alt => {
                    // Ajuste de colores para modo día/noche
                    const altBgColor = body.classList.contains('day-mode') ? 'bg-slate-300' : 'bg-slate-800/70';
                    const altBorderColor = body.classList.contains('day-mode') ? 'border-slate-400' : 'border-slate-700';
                    const altTitleColor = body.classList.contains('day-mode') ? 'text-gray-900' : 'text-yellow-300';
                    const altTextColor = body.classList.contains('day-mode') ? 'text-gray-600' : 'text-slate-400';
                    
                    html += `<div class="mt-2 text-left p-3 rounded-md ${altBgColor} border ${altBorderColor}">
                        <p class="font-bold ${altTitleColor}">${alt.activityName}</p>
                        <p class="text-xs ${altTextColor}">${alt.recommendation}</p>
                    </div>`;
                });
                planBContainer.innerHTML = html;

            } catch (error) {
                console.error("Gemini API Error (Plan B):", error);
                planBContainer.innerHTML = `<p class="text-red-400">No se pudo generar el Plan B (Error IA).</p>`;
            }
        }

    </script>
</body>
</html>